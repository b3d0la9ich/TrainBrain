{{ define "admin/submissions_list.html" }}
  {{ template "base.html" . }}
{{ end }}

{{ block "title" . }}Отправки — TrainBrain{{ end }}

{{ block "content" . }}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Отправки</h1>
    <a class="btn btn-outline-secondary" href="/admin/courses">← К курсам</a>
  </div>

  {{ if .Block }}
    <div class="alert alert-light border">
      Блок:
      <strong>
        {{ $t := "" }}
        {{ if .Block.PayloadMap }}{{ $t = (index .Block.PayloadMap "title") }}{{ end }}
        {{ if $t }}{{ $t }}{{ else }}(без названия){{ end }}
      </strong>

      <span class="text-muted">
        · тип: {{ .Block.Type }}
        · модуль #{{ .Block.Module.Order }}
        · курс: {{ .Block.Module.Course.Title }}
      </span>
    </div>
  {{ end }}

  {{ if gt (len .Submissions) 0 }}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Пользователь</th>
            <th>Курс / Модуль / Блок</th>
            <th>Файл</th>
            <th>Размер</th>
            <th>Статус / Комментарий</th>
            <th>Дата</th>
          </tr>
        </thead>

        <tbody>
          {{ range $i, $s := .Submissions }}
            <tr>
              <td>{{ $s.ID }}</td>
              <td>{{ $s.User.Email }}</td>

              <td>
                {{ $s.Block.Module.Course.Title }} /
                #{{ $s.Block.Module.Order }} {{ $s.Block.Module.Title }} /
                #{{ $s.Block.Order }}
                {{ $bt := "" }}
                {{ if $s.Block.PayloadMap }}{{ $bt = (index $s.Block.PayloadMap "title") }}{{ end }}
                {{ if $bt }} — {{ $bt }}{{ end }}
              </td>

              <td>
                {{ if $s.StoredPath }}
                  <a href="/static/{{ $s.StoredPath }}" target="_blank">
                    {{ $s.OriginalName }}
                  </a>
                {{ else }}
                  <span class="text-muted">нет файла</span>
                {{ end }}
              </td>

              <td>{{ divKB $s.SizeBytes }} КБ</td>

              <td>
                <form method="post"
                      action="/admin/submissions/{{ $s.ID }}/update"
                      class="d-flex gap-2">

                  <select name="status"
                          class="form-select form-select-sm"
                          style="max-width: 160px;">
                    {{ range $j, $st := $.Statuses }}
                      <option value="{{ $st }}" {{ if eq $s.Status $st }}selected{{ end }}>
                        {{ $st }}
                      </option>
                    {{ end }}
                  </select>

                  <input type="text"
                         name="comment"
                         class="form-control form-control-sm"
                         style="max-width: 260px;"
                         value="{{ $s.Comment }}"
                         placeholder="Комментарий">

                  <button class="btn btn-sm btn-primary">OK</button>
                </form>
              </td>

              <td>{{ $s.CreatedAt.Format "02.01.2006 15:04" }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  {{ else }}
    <div class="text-muted">Отправок пока нет.</div>
  {{ end }}

</div>
{{ end }}
