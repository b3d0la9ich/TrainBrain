{{ define "admin/block_form.html" }}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ if .Block }}Редактирование блока{{ else }}Создание блока{{ end }} — TrainBrain</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/style.css">

  <style>
    .type-panel { display: none; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/admin/">TrainBrain Admin</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-light btn-sm" href="/admin/courses">Курсы</a>
      <a class="btn btn-outline-light btn-sm" href="/">На сайт</a>
      <a class="btn btn-outline-warning btn-sm" href="/logout">Выйти</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{{ if .Block }}Редактирование блока{{ else }}Создание блока{{ end }}</h1>
    <a class="btn btn-outline-secondary btn-sm" href="/admin/courses/{{ .CourseID }}/edit">← Назад</a>
  </div>

  {{ if .Error }}
    <div class="alert alert-danger">{{ .Error }}</div>
  {{ end }}

  <form method="post" novalidate enctype="multipart/form-data">
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Тип</label>
              <select class="form-select" name="type" id="blockType">
                {{ $t := "" }}
                {{ if .Block }}{{ $t = .Block.Type }}{{ end }}
                <option value="text" {{ if eq $t "text" }}selected{{ end }}>text</option>
                <option value="video" {{ if eq $t "video" }}selected{{ end }}>video</option>
                <option value="assignment" {{ if eq $t "assignment" }}selected{{ end }}>assignment</option>
                <option value="quiz" {{ if eq $t "quiz" }}selected{{ end }}>quiz</option>
              </select>
              <div class="form-text">Тип определяет, какие поля payload будут показаны ниже.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Порядок</label>
              <input class="form-control" type="number" name="order" min="1"
                     value="{{ if .Block }}{{ .Block.Order }}{{ else }}1{{ end }}">
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Заголовок (payload.title)</label>
              <input class="form-control" type="text" name="payload_title"
                     value="{{ if .Payload }}{{ index .Payload "title" }}{{ end }}">
            </div>

            <!-- ===================== TEXT ===================== -->
            <div id="panelText" class="type-panel">
              <div class="mb-3">
                <label class="form-label">Картинка (payload.image_url)</label>

                <div class="d-flex gap-2 align-items-center">
                  <input type="file" id="imgFileText" accept="image/*" class="form-control">
                  <button type="button" class="btn btn-outline-secondary" id="btnUploadTextImg">
                    <i class="bi bi-upload"></i> Загрузить
                  </button>
                </div>

                <input type="hidden" name="payload_image_url"
                       id="payload_image_url"
                       value="{{ if .Payload }}{{ index .Payload "image_url" }}{{ end }}">

                <div class="form-text">
                  Текст отдельно. Картинка отдельно. В тексте ничего вставлять не нужно.
                </div>

                <div class="mt-2" id="imgPreviewWrap" style="display:none;">
                  <img id="imgPreview" alt=""
                       style="max-width: 260px; border-radius: 12px; border: 1px solid #e5e7eb;">
                  <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="btnClearImg">Убрать</button>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Текст (payload.text)</label>
                <textarea class="form-control" rows="10" id="payload_text" name="payload_text"
                          placeholder="Обычный текст. Переносы строк сохраняются.">{{ if .Payload }}{{ index .Payload "text" }}{{ end }}</textarea>
              </div>
            </div>

            <!-- ===================== ASSIGNMENT ===================== -->
            <div id="panelAssignment" class="type-panel">
              <div class="mb-3">
                <label class="form-label">Условие (payload.prompt)</label>
                <textarea class="form-control" rows="8" id="payload_prompt" name="payload_prompt"
                          placeholder="Обычный текст. Переносы строк сохраняются.">{{ if .Payload }}{{ index .Payload "prompt" }}{{ end }}</textarea>
              </div>
            </div>

            <!-- ===================== VIDEO ===================== -->
            <div id="panelVideo" class="type-panel">
              <div class="mb-3">
                <label class="form-label">Режим (payload.mode)</label>
                <select class="form-select" name="payload_mode">
                  {{ $m := "" }}
                  {{ if .Payload }}{{ $m = (index .Payload "mode") }}{{ end }}
                  <option value="embed" {{ if or (eq $m "") (eq $m "embed") }}selected{{ end }}>embed (iframe)</option>
                  <option value="file" {{ if eq $m "file" }}selected{{ end }}>file (mp4 path)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">URL (payload.url)</label>
                <input class="form-control" type="text" name="payload_url"
                       value="{{ if .Payload }}{{ or (index .Payload "url") (index .Payload "video_url") }}{{ end }}"
                       placeholder="Например: https://www.youtube.com/embed/...">
              </div>
              <div class="mb-3">
                <label class="form-label">Путь к файлу (payload.src)</label>
                <input class="form-control" type="text" name="payload_src"
                       value="{{ if .Payload }}{{ or (index .Payload "src") (index .Payload "path") }}{{ end }}"
                       placeholder="/static/uploads/content/....mp4">
              </div>
            </div>

            <!-- ===================== QUIZ ===================== -->
            <div id="panelQuiz" class="type-panel">
              <div class="mb-3">
                <label class="form-label">Проходной балл % (payload.pass_score)</label>
                <input class="form-control" type="number" min="0" max="100" name="payload_pass_score"
                       value="{{ if .Payload }}{{ or (index .Payload "pass_score") 70 }}{{ else }}70{{ end }}">
              </div>
              <div class="alert alert-info small mb-0">
                Вопросы/варианты редактируются на отдельной странице квиза для этого блока.
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-primary">Сохранить</button>
              <a class="btn btn-outline-secondary" href="/admin/courses/{{ .CourseID }}/edit">Отмена</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  function showPanel(type) {
    const panels = {
      text: document.getElementById('panelText'),
      assignment: document.getElementById('panelAssignment'),
      video: document.getElementById('panelVideo'),
      quiz: document.getElementById('panelQuiz'),
    };
    Object.values(panels).forEach(p => p && (p.style.display = 'none'));
    if (panels[type]) panels[type].style.display = 'block';
  }

  async function uploadImage(file) {
    const fd = new FormData();
    fd.append('image', file); // совпадает с c.FormFile("image") в adminUploadImageHandler

    const resp = await fetch('/admin/uploads/image', { method: 'POST', body: fd });
    if (!resp.ok) throw new Error('Ошибка загрузки: HTTP ' + resp.status);

    const data = await resp.json();
    if (!data || !data.url) throw new Error('Сервер не вернул url');
    return data.url;
  }

  function setPreview(url) {
    const wrap = document.getElementById('imgPreviewWrap');
    const img = document.getElementById('imgPreview');
    if (!wrap || !img) return;

    if (!url) {
      wrap.style.display = 'none';
      img.src = '';
      return;
    }
    img.src = url;
    wrap.style.display = 'block';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const typeSel = document.getElementById('blockType');
    showPanel(typeSel ? typeSel.value : 'text');
    if (typeSel) typeSel.addEventListener('change', () => showPanel(typeSel.value));

    setPreview(document.getElementById('payload_image_url')?.value || '');

    const btnUpload = document.getElementById('btnUploadTextImg');
    const fileInp = document.getElementById('imgFileText');
    const hidden = document.getElementById('payload_image_url');

    if (btnUpload && fileInp && hidden) {
      btnUpload.addEventListener('click', async () => {
        const f = fileInp.files && fileInp.files[0];
        if (!f) return alert('Выбери файл картинки');

        try {
          const url = await uploadImage(f);
          hidden.value = url;
          setPreview(url);
        } catch (e) {
          alert(e.message || 'Не удалось загрузить изображение');
        }
      });
    }

    const btnClear = document.getElementById('btnClearImg');
    if (btnClear && hidden) {
      btnClear.addEventListener('click', () => {
        hidden.value = '';
        setPreview('');
        if (fileInp) fileInp.value = '';
      });
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{{ end }}
