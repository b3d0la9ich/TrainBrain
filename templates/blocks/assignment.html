<div id="block-{{ b.id }}" class="card glass mb-3">
  <div class="card-body">
    <h5 class="card-title">
      {{ b.payload.get('title', '–ó–∞–¥–∞–Ω–∏–µ') }}
    </h5>

    {# ----- –£–°–õ–û–í–ò–ï –ó–ê–î–ê–ù–ò–Ø ----- #}
    {% if b.payload.get('prompt') %}
      <div class="card-text mb-3">
        {{ b.payload.get('prompt')|md|safe }}
      </div>
    {% endif %}

    {# ----- –ü–†–û–í–ï–†–ö–ê –¢–†–ï–ë–£–ï–¢–°–Ø –õ–ò –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –¢–ï–°–¢ ----- #}
    {% set required_quizzes = [] %}
    {% for qb in b.module.blocks %}
      {% if qb.type == 'quiz' and qb.payload.get('require_pass', True) %}
        {% set _ = required_quizzes.append(qb) %}
      {% endif %}
    {% endfor %}

    {% set ns = namespace(passed_any = false) %}
    {% for qb in required_quizzes %}
      {% for att in qb.quiz_attempts %}
        {% if att.user_id == current_user.id and att.passed %}
          {% set ns.passed_any = true %}
        {% endif %}
      {% endfor %}
    {% endfor %}

    {# ----- –ï–°–õ–ò –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù ‚Äî –ë–õ–û–ö–ò–†–£–ï–ú –û–¢–ü–†–ê–í–ö–£ ----- #}
    {% if required_quizzes and not ns.passed_any %}
      <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <div>
          –ß—Ç–æ–±—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –∑–∞–¥–∞–Ω–∏—é, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ –º–æ–¥—É–ª—é
          (–ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: {{ required_quizzes[0].payload.get('pass_score', 70) }}%).
        </div>

        <a class="btn btn-sm btn-primary"
           href="{{ url_for('course.course_view', course_id=b.module.course_id) }}#block-{{ required_quizzes[0].id }}">
          –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ—Å—Ç—É
        </a>
      </div>

      <div class="text-secondary small">
        –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.
      </div>

    {% else %}

      {# ----- –§–û–†–ú–ê –û–¢–ü–†–ê–í–ö–ò –ó–ê–î–ê–ù–ò–Ø ----- #}
      {% if current_user.is_authenticated %}
        <form method="post" enctype="multipart/form-data"
              action="{{ url_for('course.submit_assignment', block_id=b.id) }}"
              class="row g-2 mt-2">

          <div class="col-md-8">
            <input class="form-control" type="file" name="solution" required>
          </div>

          <div class="col-md-4">
            <button class="btn btn-gradient w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
          </div>
        </form>

        {# ----- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ú–û–ò–• –û–¢–ü–†–ê–í–û–ö ----- #}
        <div class="mt-3">
          <div class="fw-semibold mb-1">–ú–æ–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏:</div>

          {% set mine = [] %}
          {% for s in b.submissions %}
            {% if s.user_id == current_user.id %}
              {% set _ = mine.append(s) %}
            {% endif %}
          {% endfor %}

          {% if mine %}
            <ul class="list-group">
              {% for s in mine|sort(attribute='created_at', reverse=True) %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <i class="bi bi-file-earmark-text me-1"></i>
                    <a href="{{ url_for('static', filename=s.stored_path) }}"
                       target="_blank">{{ s.original_name }}</a>

                    <span class="text-secondary small ms-2">
                      ({{ (s.size_bytes or 0) // 1024 }} –ö–ë ¬∑ {{ s.created_at.strftime('%d.%m.%Y %H:%M') }})
                    </span>

                    {% if s.comment %}
                      <span class="text-secondary small ms-2">
                        üí¨ {{ s.comment }}
                      </span>
                    {% endif %}
                  </span>

                  <span class="badge bg-secondary">{{ s.status }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-secondary small">–û—Ç–ø—Ä–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
          {% endif %}
        </div>

      {% else %}
        <div class="alert alert-info mt-2">
          –ß—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.
        </div>
      {% endif %}

    {% endif %}
  </div>
</div>
