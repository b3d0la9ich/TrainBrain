<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ .Course.Title }} — курс</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body>
    <!-- NAV -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <i class="bi bi-lightning-charge-fill text-primary me-1"></i>TrainBrain
        </a>

        <div class="collapse navbar-collapse show">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/dashboard">Панель</a></li>
            <li class="nav-item"><a class="nav-link" href="/courses">Курсы</a></li>
            {{ if and .User (eq .User.Role "admin") }}
              <li class="nav-item"><a class="nav-link" href="/admin/">Админ</a></li>
            {{ end }}
          </ul>
          <div class="d-flex align-items-center gap-2">
            {{ if .User }}
              <span class="small text-muted"><i class="bi bi-person me-1"></i>{{ .User.Email }}</span>
              <a class="btn btn-outline-secondary btn-sm" href="/logout">Выйти</a>
            {{ else }}
              <a class="btn btn-outline-secondary btn-sm" href="/login">Войти</a>
              <a class="btn btn-gradient btn-sm" href="/register">Регистрация</a>
            {{ end }}
          </div>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="mb-0">{{ .Course.Title }}</h1>
        <a href="/courses" class="btn btn-outline-secondary">← Ко всем курсам</a>
      </div>

      {{ if .Flash }}
        <div class="alert alert-{{ .Flash.Kind }} mt-3">{{ .Flash.Msg }}</div>
      {{ end }}

      {{ if .Course.ShortDesc }}
        <p class="text-secondary">{{ .Course.ShortDesc }}</p>
      {{ end }}

      {{ range .Course.Modules }}
        <h3 class="mt-4">Модуль #{{ .Order }}: {{ .Title }}</h3>

        {{ if .Blocks }}
          {{ range .Blocks }}
            <div id="block-{{ .ID }}" class="card glass mb-3">
              <div class="card-body">

                {{/* ---------- ТЕКСТОВЫЙ БЛОК ---------- */}}
                {{ if eq .Type "text" }}
                  <h5 class="card-title">{{ index .PayloadMap "title" }}</h5>

                  {{ $img := "" }}
                  {{ if .PayloadMap }}{{ $img = (index .PayloadMap "image_url") }}{{ end }}
                  {{ if $img }}
                    <div class="mb-2">
                      <img src="{{ $img }}" alt="" class="img-fluid" style="border-radius:0.75rem;">
                    </div>
                  {{ end }}

                  {{ if index .PayloadMap "text" }}
                    <div class="card-text" style="white-space: pre-wrap;">{{ index .PayloadMap "text" }}</div>
                  {{ end }}
                {{ end }}

                {{/* ---------- ВИДЕО-БЛОК ---------- */}}
                {{ if eq .Type "video" }}
                  <h5 class="card-title">
                    {{ or (index .PayloadMap "title") "Видео" }}
                  </h5>

                  {{ $mode := or (index .PayloadMap "mode") "embed" }}

                  {{ if eq $mode "file" }}
                    {{ $src := or (index .PayloadMap "src") (index .PayloadMap "path") }}
                    {{ if $src }}
                      <video controls class="w-100" style="border-radius:0.75rem;">
                        <source src="{{ $src }}" type="video/mp4">
                        Ваш браузер не поддерживает тег video.
                      </video>
                    {{ else }}
                      <div class="text-muted small">Не указан путь к видео-файлу.</div>
                    {{ end }}
                  {{ else }}
                    {{ $url := or (index .PayloadMap "url") (index .PayloadMap "video_url") }}
                    {{ if $url }}
                      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:0.75rem;">
                        <iframe
                          src="{{ $url }}"
                          style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;"
                          frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                          allowfullscreen>
                        </iframe>
                      </div>
                    {{ else }}
                      <div class="text-muted small">Не указан URL видео.</div>
                    {{ end }}
                  {{ end }}
                {{ end }}

                {{/* ---------- ЗАДАНИЕ ---------- */}}
                {{ if eq .Type "assignment" }}
                  <h5 class="card-title">{{ index .PayloadMap "title" }}</h5>

                  {{ if index .PayloadMap "prompt" }}
                    <div class="card-text mb-2" style="white-space: pre-wrap;">{{ index .PayloadMap "prompt" }}</div>
                  {{ end }}

                  {{ if .LastSubmission }}
                    <div class="alert alert-secondary py-2 small mb-2">
                      <div><b>Последняя отправка:</b> {{ .LastSubmission.Status }}</div>
                      {{ if .LastSubmission.Comment }}
                        <div><b>Комментарий:</b> {{ .LastSubmission.Comment }}</div>
                      {{ end }}
                      {{ if .LastSubmission.OriginalName }}
                        <div><b>Файл:</b> {{ .LastSubmission.OriginalName }}</div>
                      {{ end }}
                    </div>
                  {{ end }}

                  {{ if $.User }}
                    <form method="post" enctype="multipart/form-data"
                          action="/submit/{{ .ID }}" class="row g-2 mt-2">
                      <div class="col-md-8">
                        <input class="form-control" type="file" name="file" required>
                      </div>
                      <div class="col-md-4">
                        <button class="btn btn-gradient w-100">Отправить решение</button>
                      </div>
                    </form>
                  {{ else }}
                    <div class="alert alert-info mt-2">
                      Для отправки решения нужно войти.
                    </div>
                  {{ end }}
                {{ end }}

                {{/* ---------- КВИЗ ---------- */}}
                {{ if eq .Type "quiz" }}
                  <h5 class="card-title">{{ or (index .PayloadMap "title") "Тест" }}</h5>
                  <div class="text-secondary small mb-2">
                    Проходной балл: {{ or (index .PayloadMap "pass_score") 70 }}%
                  </div>

                  {{ if and .LastAttempt .LastAttempt.Passed }}
                    <div class="alert alert-success py-2 small mb-3">
                      ✅ Тест пройден.
                      Балл: {{ printf "%.1f" .LastAttempt.Score }}%
                    </div>
                  {{ end }}

                  {{ if $.User }}
                    {{ if and .LastAttempt .LastAttempt.Passed }}
                      {{/* ничего */}}
                    {{ else }}
                      <form method="post" action="/courses/{{ .ID }}/quiz-submit">
                        {{ range $qi, $q := .QuizQuestions }}
                          <div class="border rounded p-3 mb-3">
                            <div class="fw-semibold mb-2">
                              Вопрос {{ $qi | add 1 }}. {{ $q.Text }}
                            </div>
                            {{ range $oi, $opt := $q.Options }}
                              <div class="form-check">
                                <input class="form-check-input" type="radio"
                                       name="question_{{ $q.ID }}"
                                       value="{{ $opt.ID }}"
                                       id="q{{ $q.ID }}o{{ $opt.ID }}">
                                <label class="form-check-label" for="q{{ $q.ID }}o{{ $opt.ID }}">
                                  {{ $opt.Text }}
                                </label>
                              </div>
                            {{ end }}
                          </div>
                        {{ end }}
                        <button class="btn btn-gradient">Отправить ответы</button>
                      </form>
                    {{ end }}
                  {{ else }}
                    <div class="alert alert-info mt-2">
                      Чтобы пройти тест, войдите в аккаунт.
                    </div>
                  {{ end }}
                {{ end }}

              </div>
            </div>
          {{ end }}
        {{ else }}
          <div class="text-secondary">В модуле нет блоков.</div>
        {{ end }}
      {{ else }}
        <div class="text-secondary">Модулей пока нет.</div>
      {{ end }}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
